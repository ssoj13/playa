name: Release

on:
  push:
    tags:
      - 'v*'  # Only build on version tags (v0.1.26, etc.)
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Path to run: auto | release | dev'
        required: false
        default: auto
        type: choice
        options:
          - auto
          - release
          - dev

permissions:
  contents: write  # Required for creating releases and uploading artifacts
  actions: read    # Required to query workflow runs

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:
  # Wait for any running warm-cache workflows on this commit
  wait-for-cache:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for warm-cache workflow to complete
        uses: actions/github-script@v8
        with:
          script: |
            const maxWaitMinutes = 60;
            const pollIntervalSeconds = 30;
            const maxAttempts = (maxWaitMinutes * 60) / pollIntervalSeconds;

            const { owner, repo } = context.repo;
            const sha = context.sha;

            core.info(`Checking for warm-cache workflows running on commit ${sha.substring(0, 8)}...`);

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              // Get all runs for warm-cache workflow
              const workflows = await github.rest.actions.listRepoWorkflows({
                owner,
                repo
              });

              const warmCacheWorkflow = workflows.data.workflows.find(w => w.name === 'Warm Cache');

              if (!warmCacheWorkflow) {
                core.info('No warm-cache workflow found, proceeding...');
                return;
              }

              // Get runs for this SHA
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: warmCacheWorkflow.id,
                head_sha: sha,
                per_page: 10
              });

              const runningRuns = runs.data.workflow_runs.filter(
                r => r.status === 'in_progress' || r.status === 'queued'
              );

              if (runningRuns.length === 0) {
                core.info('No warm-cache workflows running for this commit, proceeding...');
                return;
              }

              const runUrls = runningRuns.map(r => r.html_url).join(', ');
              core.info(`‚è≥ Waiting for ${runningRuns.length} warm-cache run(s) to complete...`);
              core.info(`   Runs: ${runUrls}`);
              core.info(`   Attempt ${attempt}/${maxAttempts}, next check in ${pollIntervalSeconds}s`);

              if (attempt < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, pollIntervalSeconds * 1000));
              }
            }

            core.warning(`Timeout waiting for warm-cache after ${maxWaitMinutes} minutes, proceeding anyway...`);

  # Check if the tag is on main branch
  check-branch:
    needs: wait-for-cache
    runs-on: ubuntu-latest
    outputs:
      on-main: ${{ steps.check.outputs.on-main }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch all history to check branches

      - name: Check if tag is on main branch
        id: check
        shell: bash
        run: |
          set -euo pipefail
          git fetch --no-tags origin +refs/heads/*:refs/remotes/origin/*
          TAG_SHA="${GITHUB_SHA}"
          if git rev-parse --verify origin/main >/dev/null 2>&1; then
            if git merge-base --is-ancestor "$TAG_SHA" origin/main; then
              echo "on-main=true" >> "$GITHUB_OUTPUT"
              echo "Tag commit is in origin/main - release path"
            else
              echo "on-main=false" >> "$GITHUB_OUTPUT"
              echo "Tag commit is NOT in origin/main - dev path"
            fi
          else
            echo "on-main=false" >> "$GITHUB_OUTPUT"
            echo "origin/main not found after fetch - treating as dev path"
          fi

  build-windows:
    needs: check-branch
    uses: ./.github/workflows/_build-platform.yml
    with:
      runner: windows-latest
      platform: windows
      branch_condition: ${{ (((github.event_name == 'workflow_dispatch') && (inputs.build_type == 'release' || (inputs.build_type == 'auto' && needs.check-branch.outputs.on-main == 'true'))) || (github.event_name != 'workflow_dispatch' && needs.check-branch.outputs.on-main == 'true')) && 'true' || 'false' }}
      should_release: ${{ (github.event_name == 'workflow_dispatch' && (inputs.build_type == 'release' || (inputs.build_type == 'auto' && needs.check-branch.outputs.on-main == 'true'))) || (github.event_name != 'workflow_dispatch' && needs.check-branch.outputs.on-main == 'true') }}
    secrets: inherit

  build-linux:
    needs: check-branch
    uses: ./.github/workflows/_build-platform.yml
    with:
      runner: ubuntu-latest
      platform: linux
      branch_condition: ${{ (((github.event_name == 'workflow_dispatch') && (inputs.build_type == 'release' || (inputs.build_type == 'auto' && needs.check-branch.outputs.on-main == 'true'))) || (github.event_name != 'workflow_dispatch' && needs.check-branch.outputs.on-main == 'true')) && 'true' || 'false' }}
      should_release: ${{ (github.event_name == 'workflow_dispatch' && (inputs.build_type == 'release' || (inputs.build_type == 'auto' && needs.check-branch.outputs.on-main == 'true'))) || (github.event_name != 'workflow_dispatch' && needs.check-branch.outputs.on-main == 'true') }}
    secrets: inherit

  build-macos:
    needs: check-branch
    uses: ./.github/workflows/_build-platform.yml
    with:
      runner: macos-latest
      platform: macos
      branch_condition: ${{ (((github.event_name == 'workflow_dispatch') && (inputs.build_type == 'release' || (inputs.build_type == 'auto' && needs.check-branch.outputs.on-main == 'true'))) || (github.event_name != 'workflow_dispatch' && needs.check-branch.outputs.on-main == 'true')) && 'true' || 'false' }}
      should_release: ${{ (github.event_name == 'workflow_dispatch' && (inputs.build_type == 'release' || (inputs.build_type == 'auto' && needs.check-branch.outputs.on-main == 'true'))) || (github.event_name != 'workflow_dispatch' && needs.check-branch.outputs.on-main == 'true') }}
    secrets: inherit
