name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v0.4.7, v1.0.0, etc.
    branches:
      - main  # Only allow releases from main branch
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required for creating releases and uploading artifacts

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly

      - name: Install cargo-packager
        run: cargo install cargo-packager --version 0.11.7 --locked

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "stable"
          save-if: true
          # Don't include Cargo.lock hash in cache key to avoid invalidation on version changes
          key: "rust-deps"
          cache-bin: false

      - name: Build the application
        run: cargo xtask build --release

      - name: Package the application
        run: cargo packager --release

      - name: Find installer
        id: find_installer
        shell: pwsh
        run: |
          $installer = Get-ChildItem -Path "target/release" -Filter "playa_*-setup.*" | Select-Object -First 1
          if ($installer) {
            $relativePath = "target/release/$($installer.Name)"
            echo "path=$relativePath" >> $env:GITHUB_OUTPUT
            echo "Found installer: $($installer.FullName)"
            echo "Using relative path: $relativePath"
          } else {
            echo "Installer not found in target/release"
            exit 1
          }

      - name: Create portable ZIP
        shell: pwsh
        run: |
          # Get version from Cargo.toml
          $version = (Select-String -Path "Cargo.toml" -Pattern 'version = "([^"]+)"').Matches.Groups[1].Value

          # Create directory for portable version
          New-Item -ItemType Directory -Force -Path "portable" | Out-Null

          # Copy exe
          Copy-Item "target/release/playa.exe" -Destination "portable/"

          # Copy all dll files
          Get-ChildItem -Path "target/release" -Filter "*.dll" | Copy-Item -Destination "portable/"

          # Create zip
          $zipName = "playa-${version}-windows-portable.zip"
          Compress-Archive -Path "portable/*" -DestinationPath "target/release/$zipName" -Force

          echo "Created portable ZIP: $zipName"
          echo "Contents:"
          Get-ChildItem "portable" | Format-Table Name, Length

      - name: Upload Windows artifacts (installer + portable)
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            ${{ steps.find_installer.outputs.path }}
            target/release/playa-*-windows-portable.zip
          if-no-files-found: warn
          retention-days: 7

      - name: Upload Release Assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.find_installer.outputs.path }}
            target/release/playa-*-windows-portable.zip
          fail_on_unmatched_files: false

  # TODO: Re-enable macOS build after fixing cross-compilation issues
  # build-macos:
  #   runs-on: macos-latest
  #   continue-on-error: true  # Don't fail the whole workflow if macOS build fails
  #   strategy:
  #     matrix:
  #       target: [x86_64-apple-darwin]
  #       # TODO: add aarch64-apple-darwin with macos-14 runner for Apple Silicon
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: Install dependencies
  #       run: brew install cmake
  #
  #     - name: Install Rust toolchain
  #       uses: dtolnay/rust-toolchain@nightly
  #       with:
  #         targets: ${{ matrix.target }}
  #
  #     - name: Cache cargo dependencies
  #       uses: Swatinem/rust-cache@v2
  #       with:
  #         shared-key: "stable"
  #         key: ${{ matrix.target }}
  #
  #     - name: Install cargo-packager
  #       uses: baptiste0928/cargo-install@v3
  #       with:
  #         crate: cargo-packager
  #         version: "0.11.7"
  #         cache-key: ${{ runner.os }}
  #
  #     - name: Build the application
  #       run: cargo build --release --target ${{ matrix.target }}
  #       continue-on-error: true
  #
  #     - name: Package the application
  #       run: cargo packager --release --target ${{ matrix.target }}
  #       continue-on-error: true
  #
  #     - name: List bundle contents (if successful)
  #       continue-on-error: true
  #       run: |
  #         if [ -d "target/release/bundle" ]; then
  #           ls -R target/release/bundle/
  #         else
  #           echo "Bundle directory not found - build likely failed for ${{ matrix.target }}"
  #           exit 0
  #         fi
  #
  #     - name: Find DMG
  #       id: find_dmg
  #       continue-on-error: true
  #       run: |
  #         dmg=$(find target/release/bundle/dmg -name "*.dmg" 2>/dev/null | head -n 1)
  #         if [ -n "$dmg" ]; then
  #           echo "path=$dmg" >> $GITHUB_OUTPUT
  #           echo "Found DMG: $dmg"
  #         fi
  #
  #     - name: Upload Release Assets
  #       if: steps.find_dmg.outputs.path != ''
  #       uses: softprops/action-gh-release@v1
  #       with:
  #         files: ${{ steps.find_dmg.outputs.path }}
  #         fail_on_unmatched_files: false

  # TODO: Re-enable Linux build after fixing dependencies issues
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake libgtk-3-dev libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev libspeechd-dev libxkbcommon-dev libssl-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly

      - name: Install cargo-packager
        run: cargo install cargo-packager --version 0.11.7 --locked

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "stable"
          save-if: true
          key: "rust-deps"
          cache-bin: false

      - name: Fetch dependencies
        run: cargo fetch

      - name: Build the application (with xtask)
        run: cargo xtask build --release

      - name: Package the application
        run: |
          export LD_LIBRARY_PATH="$(pwd)/target/release:$LD_LIBRARY_PATH"
          cargo packager --release

      - name: List bundle contents (if successful)
        run: |
          if [ -d "target/release/bundle" ]; then
            ls -R target/release/bundle/
          else
            echo "Bundle directory not found - build likely failed"
            exit 0
          fi

      - name: Find AppImage
        id: find_appimage
        run: |
          # Prefer top-level target/release output from cargo-packager
          appimage=$(find target/release -maxdepth 1 \( -name "*.AppImage" -o -name "*.appimage" \) 2>/dev/null | head -n 1)
          # Fallback to legacy bundle path if needed
          if [ -z "$appimage" ]; then
            appimage=$(find target/release/bundle/appimage -name "*.AppImage" 2>/dev/null | head -n 1)
          fi
          if [ -n "$appimage" ]; then
            echo "path=$appimage" >> $GITHUB_OUTPUT
            echo "Found AppImage: $appimage"
          else
            echo "No AppImage found"
          fi

      - name: Find DEB
        id: find_deb
        run: |
          # Prefer top-level target/release output from cargo-packager
          deb=$(find target/release -maxdepth 1 -name "*.deb" 2>/dev/null | head -n 1)
          # Fallback to legacy bundle path if needed
          if [ -z "$deb" ]; then
            deb=$(find target/release/bundle/deb -name "*.deb" 2>/dev/null | head -n 1)
          fi
          if [ -n "$deb" ]; then
            echo "path=$deb" >> $GITHUB_OUTPUT
            echo "Found DEB: $deb"
          else
            echo "No DEB found"
          fi

      - name: Upload Linux AppImage artifact
        if: steps.find_appimage.outputs.path != ''
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: ${{ steps.find_appimage.outputs.path }}
          retention-days: 7
          if-no-files-found: error

      - name: Upload Linux DEB artifact
        if: steps.find_deb.outputs.path != ''
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: ${{ steps.find_deb.outputs.path }}
          retention-days: 7
          if-no-files-found: error

      - name: Upload Release Assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.find_appimage.outputs.path }}
            ${{ steps.find_deb.outputs.path }}
          fail_on_unmatched_files: false
