# Наблюдения перед стартом
- Инструкции task5/task6 требуют восстановить бары на таймлайне, drag’n’drop и загрузку кадров, при этом сразу учитывать egui_taffy/egui_dock/egui_dnd.
- Текущий `Comp::get_frame/compose` не имеет ветки File-mode: для файловых композиций кадры всегда `None`, Loader не задействован — отсюда «кадры не загружаются».
- Таймлайн рисует только `children` текущего Comp; после загрузки секвенций активный Comp в File-режиме пустой (нет children_attrs), поэтому бары не появляются и dnd впустую отрабатывает.
- egui_dock/egui_taffy пока не подключены (нет deps/инициализации), панели жестко прибиты (SidePanel/TopBottom), hotkeys/event wiring частично из старого кода.
- В .orig/.orig2 есть рабочие заготовки загрузки/таймлайна; нужно сравнить и аккуратно перенести ключевые куски вместо попыток гадать.

# План v6 (сортивка по приоритету: сначала dock/taffy/dnd)
1) Интеграция egui_dock + egui_taffy + egui_dnd (база для остального)  
   - Добавить egui_taffy (совместимую с eframe 0.33/egui 0.27) в зависимости; проверить версии egui_dock/egui_dnd.  
   - Собрать DockState (Viewport/Timeline/Project/AE) через TabViewer; обеспечить восстановление/сброс макета.  
   - Подготовить taffy-лейауты для панелей/внутри таймлайна/проекта (row/column/flex/grid вместо ручных paddings), проверить, что egui_dnd не конфликтует.

2) Привести спецификацию к действующему набору модулей  
   - Сравнить текущие `src` с `.orig` и `.orig2` для ключевых узлов (Comp/Frame/Loader/Timeline UI, main/ui/player).  
   - Зафиксировать целевую структуру сущностей (Comp в двух режимах, Project с руками для children_attrs) и необходимых интерфейсов UI/событий.

3) Починить загрузку кадров (File mode end-to-end)  
   - Реализовать File-ветку в `Comp::get_frame/compose`: построение пути по `file_mask`/`padding`, вызов `Loader::load`, кэш по hash/play_range.  
   - Убедиться, что Loader/Frame работают с обоими бэкендами; добавить hash/mtime для инвалидации.  
   - Подключить рабочие события/воркеры: восстановить `CompEvent::CurrentFrameChanged` обработку, прелоад вокруг playhead.

4) Восстановить таймлайн и структуру проектов  
   - Решить, какой Comp отображаем: создать/обеспечить главный Layer-comp, куда кладутся все File-компы как дети (с заполнением children_attrs start/end/play_*).  
   - Починить `add_child_with_duration/move_child` и расчёты рамок, чтобы бары получали валидные старт/конец и подсветки; обеспечить selection/edges API.  
   - Обновить сериализацию/rehydration Project/Comp, чтобы children_attrs и режим сохранялись/восстанавливались единообразно.

5) Вернуть drag’n’drop и управление таймлайном  
   - Проверить pipeline: OS/кнопки ➜ Project list (drag handle) ➜ global drag state ➜ Timeline drop ➜ `AddLayer`/`MoveLayer` действий. Исправить места, где состояние не чистится/не создаётся.  
   - Добавить защиту от пустых композиций: placeholder бар/рулер, клэмпы в map screen↔frame.  
   - Перепривязать хоткеи таймлайна (J/K/L, B/N/Ctrl-B, [, ]) к event bus/Comp API.

6) Проверки и долговечность  
   - Ручной пробег сценариев: загрузка секвенции, отображение бара, скраб/zoom/pan, dnd из Project в таймлайн, trim/play area, воспроизведение (кадры реально появляются в viewport).  
   - Минимальные тесты для File-mode: построение пути кадра, кэш/хэш инвалидация, map_global_to_local (если добавим).  
   - Обновить README/док-заметки при необходимости и записать ограничения/дальнейшие шаги.
