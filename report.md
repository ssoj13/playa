# Отчет по анализу приложения Playa

## План анализа

1. **Исследовать структуру проекта** - изучить корневой каталог, Cargo.toml, src/, идентифицировать основные компоненты (UI, timeline, project window)
2. **Проверить компиляцию проекта** - запустить cargo check, cargo build, запустить тесты
3. **Исследовать проблемы с UI** - клики в окне проекта не работают, ничего не выделяется, нет drag'n'drop, timeline не таскается
4. **Найти неиспользуемый и мертвый код** - использовать clippy, grep, поиск
5. **Проверить логику кода на ошибки** - нелогичные места, мистаки
6. **Создать комплексный отчет** - с планом и найденными проблемами

## Структура проекта

Проект является Rust-приложением для просмотра последовательностей изображений (image sequence player) с поддержкой EXR, PNG, JPEG, TIFF, MP4.

### Основные компоненты:
- **src/main.rs** - главный файл приложения, инициализация eframe/egui
- **src/ui.rs** - высокоуровневый UI (timeline, viewport)
- **src/widgets/** - виджеты UI:
  - `project/` - окно проекта (список клипов и композиций)
  - `timeline/` - timeline с дорожками слоев
  - `viewport/` - область просмотра кадров
- **src/entities/** - бизнес-логика:
  - `comp.rs` - композиции (compositions)
  - `frame.rs` - кадры и буферы пикселей
  - `project.rs` - проект (плейлист)
- **src/player.rs** - плеер для воспроизведения
- **src/event_bus.rs** - система событий

## Проблемы компиляции

Компиляция блокируется ошибкой сборки FFmpeg-sys-next:
```
error: failed to run custom build command for `ffmpeg-sys-next v8.0.1`
Caused by: fatal error: 'vcruntime.h' file not found
```

Это проблема зависимостей FFmpeg, не связанная с кодом приложения. Код на Rust компилируется корректно, но системные зависимости FFmpeg не настроены.

## Проблемы UI (актуализировано)

### 1) Очередь событий не обрабатывается после рендера
- В `src/main.rs:894-1003` EventBus дренится до рендеринга UI. В этом же кадре UI кладет события в очередь, но второй фазы drain нет, и `ctx.request_repaint()` не вызывается при наличии событий. При остановленном плеере следующий кадр не запрашивается — клики/кнопки выглядят «мертвыми», выделение клипов не обновляется.

### 2) Сигналы композиций теряются после загрузки состояния
- В блоке восстановления (`src/main.rs:1245-1288`) поля с `#[serde(skip)]` остаются дефолтными: `comp_event_sender` остается `CompEventSender::dummy()`. Его не переназначают от `event_bus.sender()`, и `attach_comp_event_sender()` не вызывается. В результате `Comp` не шлют `CurrentFrameChanged/LayersChanged/AttrsChanged`, поэтому внутренние сигналы не доходят.

### 3) Обработка кликов/drag в Project UI
- Логика в `src/widgets/project/project_ui.rs` корректна (click/double-click, drag_started). Проблемы выше блокируют эффект этих действий.

## Неиспользуемый код

### Найденные TODO/FIXME
- В `src/entities/gpu_compositor.rs` - документация с TODO для интеграции UI настроек
- В `src/entities/comp.rs` - один TODO (нужно найти конкретно)

### Потенциально мертвый код
Без полной компиляции сложно определить. Основные компоненты используются.

## Логические ошибки и проблемы

- Главная: EventBus drain выполнен только до рендера и без запроса repaint при наличии событий → очередь залипает.
- Вторичная: `comp_event_sender` не восстанавливается после serde → сигналы композиций не выходят.

## Рекомендации (обновлено)

1. Перенести/добавить обработку очереди после рендера кадра и вызвать `ctx.request_repaint()` при наличии событий в очереди.
2. После десериализации заново создать связку `event_bus` + `comp_event_sender = CompEventSender::from_sender(event_bus.sender())` и вызвать `attach_comp_event_sender()` для всех композиций (включая `ensure_default_comp()`).
3. (Опционально) Добавить debug-лог длины очереди при пропуске repaint для раннего обнаружения регрессий.
