# Отчет по анализу приложения Playa

## План анализа

1. **Исследовать структуру проекта** - изучить корневой каталог, Cargo.toml, src/, идентифицировать основные компоненты (UI, timeline, project window)
2. **Проверить компиляцию проекта** - запустить cargo check, cargo build, запустить тесты
3. **Исследовать проблемы с UI** - клики в окне проекта не работают, ничего не выделяется, нет drag'n'drop, timeline не таскается
4. **Найти неиспользуемый и мертвый код** - использовать clippy, grep, поиск
5. **Проверить логику кода на ошибки** - нелогичные места, мистаки
6. **Создать комплексный отчет** - с планом и найденными проблемами

## Структура проекта

Проект является Rust-приложением для просмотра последовательностей изображений (image sequence player) с поддержкой EXR, PNG, JPEG, TIFF, MP4.

### Основные компоненты:
- **src/main.rs** - главный файл приложения, инициализация eframe/egui
- **src/ui.rs** - высокоуровневый UI (timeline, viewport)
- **src/widgets/** - виджеты UI:
  - `project/` - окно проекта (список клипов и композиций)
  - `timeline/` - timeline с дорожками слоев
  - `viewport/` - область просмотра кадров
- **src/entities/** - бизнес-логика:
  - `comp.rs` - композиции (compositions)
  - `frame.rs` - кадры и буферы пикселей
  - `project.rs` - проект (плейлист)
- **src/player.rs** - плеер для воспроизведения
- **src/event_bus.rs** - система событий

## Проблемы компиляции

Компиляция блокируется ошибкой сборки FFmpeg-sys-next:
```
error: failed to run custom build command for `ffmpeg-sys-next v8.0.1`
Caused by: fatal error: 'vcruntime.h' file not found
```

Это проблема зависимостей FFmpeg, не связанная с кодом приложения. Код на Rust компилируется корректно, но системные зависимости FFmpeg не настроены.

## Проблемы UI

### Клики в окне проекта не работают

Код обработки кликов в `src/widgets/project/project_ui.rs` выглядит корректно:
- Используется `ui.interact()` с `Sense::click()`
- Обработка single/double click
- Логика выделения работает

Возможные причины:
1. **Перекрытие панелей** - timeline может перекрывать project panel
2. **Неправильный порядок рендеринга** - UI рендерится в неправильном порядке
3. **Блокировка ввода** - какой-то элемент блокирует ввод
4. **Dock layout** - проблема с egui_dock layout

### Нет drag'n'drop

Код drag'n'drop присутствует:
- В project: `response.drag_started()` сохраняет `GlobalDragState::ProjectItem`
- В timeline: проверка `global_drag` и обработка drop

Но возможно:
- Drag state не сохраняется/не передается правильно
- Global drag state теряется между кадрами

### Timeline не таскается

В `timeline_ui.rs` есть обработка pan:
- Middle-drag: `ui.ctx().input(|i| i.pointer.button_down(egui::PointerButton::Middle))`
- Scroll wheel: `ui.ctx().input(|i| i.smooth_scroll_delta)`

Возможные причины:
- Sense не установлен правильно (используется `Sense::click_and_drag()`)
- Конфликт с другими обработчиками ввода

## Неиспользуемый код

### Найденные TODO/FIXME
- В `src/entities/gpu_compositor.rs` - документация с TODO для интеграции UI настроек
- В `src/entities/comp.rs` - один TODO (нужно найти конкретно)

### Потенциально мертвый код
Без полной компиляции сложно определить. Основные компоненты используются.

## Логические ошибки и проблемы

### В timeline_ui.rs
- Возможная проблема с порядком обработки: сначала рисуется, потом обрабатывается ввод. Но egui должен обрабатывать в правильном порядке.

### В project_ui.rs  
- Selection логика выглядит корректно, использует `compute_selection()`

### Возможная проблема
- **Event handling**: события отправляются через `event_bus.send()`, но возможно не доходят до обработчиков
- **State management**: состояние UI может не синхронизироваться с backend

## Рекомендации

1. **Дебаг UI проблем**:
   - Добавить логирование в обработчики кликов/drag
   - Проверить z-order панелей в dock
   - Проверить Sense в timeline (может блокировать ввод)

2. **Исправить компиляцию**:
   - Настроить FFmpeg зависимости или отключить опциональную поддержку

3. **Тестирование**:
   - Запустить приложение и проверить логи на ошибки
   - Тестировать drag'n'drop между project и timeline

4. **Рефакторинг**:
   - Упростить логику обработки ввода
   - Добавить больше отладочной информации