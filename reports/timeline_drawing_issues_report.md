# Отчёт о проблемах с рисованием таймлайна

## Дата: 2024-12-19

## Обнаруженные проблемы

### 1. Индикатор кэширования показывает кэширование не на текущем тайм слайдере

**Проблема:** Индикатор кэширования отображается не на текущем тайм слайдере, а где-то сбоку (слева или справа).

**Причина:** 
- В функции `draw_load_indicator` используется `ui.allocate_exact_size`, что создаёт новое пространство в layout после ruler
- Индикатор размещается после ruler в горизонтальном layout, поэтому его `rect.min.x` не совпадает с `ruler_rect.min.x`
- Для вычисления позиций кадров используется `ruler_rect.min.x` (правильно), но для рисования используется `rect.min.y` (может быть неправильно)

**Исправление:**
- Использовать `ruler_rect.min.x` для вычисления позиций кадров (уже сделано)
- Использовать `ruler_rect` для ограничения видимой области рисования
- Убедиться, что индикатор рисуется только в видимой области ruler

### 2. Индикатор занимает весь таймлайн и не привязан к timeruler ticks

**Проблема:** Индикатор занимает весь таймлайн и не привязан к timeruler ticks.

**Причина:**
- Индикатор рисуется для всех кадров в диапазоне `visible_start_frame..visible_end_frame`, но не ограничивается видимой областью ruler
- Используется `ruler_rect.width()` для расчёта видимого диапазона, но это может не совпадать с фактической видимой областью

**Исправление:**
- Использовать тот же расчёт видимого диапазона, что и в `draw_frame_ruler`
- Ограничить рисование только видимой областью ruler (между `ruler_rect.min.x` и `ruler_rect.max.x`)
- Использовать `ruler_rect.min.x` как базовую позицию для вычисления позиций кадров

### 3. Разные оффсеты слева в режимах Canvas и Split

**Проблема:** У окон canvas и split по-разному рисуются оффсеты слева.

**Причина:**
- В Split режиме не добавляется спейсер слева (строка 330 в `timeline_ui.rs`)
- В non-Split режиме добавляется спейсер шириной `config.name_column_width`
- Это приводит к тому, что `ruler_rect.min.x` и `timeline_rect.min.x` имеют разные значения в разных режимах

**Исправление:**
- Убедиться, что `timeline_rect` также учитывает наличие спейсера в non-Split режиме
- Использовать одинаковую базовую позицию для всех элементов (ruler, indicator, timeline bars)

## Внесённые исправления

1. **Исправлен `draw_load_indicator`:**
   - Используется `ruler_rect.min.x` для вычисления позиций кадров
   - Используется `ruler_rect.width()` для расчёта видимого диапазона
   - Ограничено рисование только видимой областью ruler

2. **Улучшен расчёт видимых кадров:**
   - Используется тот же алгоритм, что и в `draw_frame_ruler`
   - Учитывается `state.pan_offset` и `ruler_rect.width()`

## Дополнительные замечания

### Проблема с синхронизацией timeline_rect и ruler_rect

В коде используется `timeline_rect.min.x` для вычисления позиций кадров в слоях, но `ruler_rect.min.x` для вычисления позиций в ruler и индикаторе. Это может привести к рассинхронизации, если `timeline_rect.min.x` не совпадает с `ruler_rect.min.x`.

**Текущее поведение:**
- `ruler_rect` создается через `draw_frame_ruler` внутри `ui.horizontal` с условным спейсером
- `timeline_rect` создается через `allocate_painter` внутри `ScrollArea`, который размещается после всех элементов выше
- В Split режиме спейсер не добавляется, в non-Split режиме добавляется

**Потенциальная проблема:**
Если `timeline_rect.min.x` не совпадает с `ruler_rect.min.x`, то слои будут выровнены неправильно относительно ruler ticks.

**Рекомендация:**
Проверить, что `timeline_rect.min.x` совпадает с `ruler_rect.min.x` в обоих режимах (Split и non-Split). Если нет, нужно использовать `ruler_rect.min.x` для вычисления позиций кадров в слоях.

## Рекомендации для дальнейшей проверки

1. Проверить, что индикатор правильно выравнивается с ticks в ruler при разных уровнях zoom
2. Проверить, что индикатор правильно работает при панорамировании таймлайна
3. Проверить, что оффсеты одинаковы в Split и non-Split режимах
4. Проверить, что индикатор не рисуется за пределами видимой области
5. **Проверить, что `timeline_rect.min.x` совпадает с `ruler_rect.min.x` в обоих режимах**

## Файлы, затронутые изменениями

- `src/widgets/timeline/timeline_helpers.rs` - функция `draw_load_indicator`

